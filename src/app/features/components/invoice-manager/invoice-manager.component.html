<!-- Barra superior -->
<header class="topbar">
  <div class="brand">
    <span class="icon">üßæ</span>
    <div>
      <h1>Gesti√≥n de Facturas</h1>
      <p>Sistema de procesamiento autom√°tico</p>
    </div>
  </div>

  <!-- <button class="btn-outline" (click)="goToSecciones()">
    Pendientes ({{ pending() }})
  </button> -->
</header>

<main class="container">
  <!-- Lista -->
  <section class="list">
    <div class="facts">
      <h2>Mis Facturas</h2>
      <!-- <p>Facturas: {{ correctInvoices() }} de {{ totalInvoices() }}</p> -->
    </div>

    <!-- Filtro de usuarios -->
    <div class="user-filter" *ngIf="availableUsers().length > 0">
      <label class="filter-label" for="userSelect">Filtrar por usuario:</label>
      <select
        id="userSelect"
        class="filter-select"
        (change)="onUserSelectChange($event)"
      >
        <option value="">Todos los usuarios</option>
        <option
          *ngFor="let user of availableUsers()"
          [value]="user"
          [selected]="isUserSelected(user)"
        >
          {{ user }}
        </option>
      </select>
    </div>

    <div class="card" *ngFor="let row of filteredInvoices()">
      <div class="left">
        <span class="error-dot">!</span>
        <div class="meta">
          <div class="name">{{ row.fileName }}</div>
          <div class="date">
            {{ row.createdAt }}
            <span *ngIf="row.userName" class="user-name"
              >¬∑ {{ row.userName }}</span
            >
          </div>
          <div class="elapsed-time">
            {{ getElapsedTime(row.entryTime) }}
            <!-- SOLO SI NO VIENE DE LA BBDD-->
          </div>
        </div>
        <div></div>
      </div>

      <div class="right">
        <button class="btn" (click)="open(row)">Corregir</button>
      </div>
    </div>
  </section>
</main>

<!-- Modal -->
<div
  class="modal-backdrop"
  *ngIf="selectedInvoice() as inv"
  (click)="closeModal()"
></div>

<div
  class="modal-revision"
  *ngIf="selectedInvoice() as inv"
  role="dialog"
  aria-modal="true"
>
  <!-- Header del modal -->
  <header class="modal-revision-header">
    <div class="header-left">
      <h1 class="header-title">REVISI√ìN DE FACTURA</h1>
      <span class="header-doc-number">#{{ lastNumDoc() ?? inv.id }}</span>
    </div>
    <div class="header-actions">
      <button
        type="button"
        class="btn-header btn-outline-header"
        (click)="closeModal()"
      >
        <span class="btn-icon">‚Üê</span> VOLVER AL DETALLE DE LOTE
      </button>
      <button
        type="button"
        class="btn-header btn-outline-header"
        (click)="discardInvoice()"
      >
        <span class="btn-icon">üèõ</span> INCOMPLETA
      </button>
      <button
        type="button"
        class="btn-header btn-primary-header"
        (click)="saveDataAndSend()"
      >
        <span class="btn-icon">üíæ</span> GUARDAR FACTURA
      </button>
    </div>
  </header>

  <!-- Body del modal -->
  <div class="modal-revision-body">
    <!-- Panel PDF/Imagen -->
    <div class="pdf-panel" [style.width.%]="leftPanelWidth()">
      <div class="pdf-container">
        <div
          #visualizador
          class="pdf-viewer"
          [innerHTML]="iframe"
          [style.transform]="'scale(' + pdfZoom() + ')'"
        ></div>
        <button class="pdf-external-link" title="Abrir en nueva ventana">
          <span>‚ßâ</span>
        </button>
      </div>
      <div class="pdf-controls">
        <button type="button" class="zoom-btn" (click)="zoomOut()" title="Reducir">‚àí</button>
        <span class="zoom-level">{{ (pdfZoom() * 100) | number:'1.0-0' }}%</span>
        <button type="button" class="zoom-btn" (click)="zoomIn()" title="Ampliar">+</button>
        <button type="button" class="zoom-btn zoom-reset" (click)="resetZoom()" title="Restablecer">‚Ü∫</button>
      </div>
    </div>

    <!-- Divisor arrastrable -->
    <div
      class="resizer"
      (mousedown)="startResize($event)"
      (touchstart)="startResize($event)"
    >
      <div class="resizer-handle"></div>
    </div>

    <!-- Panel Formulario -->
    <div class="form-panel" [style.width.%]="rightPanelWidth()">
      <form [formGroup]="form" (ngSubmit)="saveDataAndSend()">
        <!-- Ocultos -->
        <input type="hidden" formControlName="url" />
        <input type="hidden" formControlName="valid" />

        <!-- IDENTIFICACI√ìN -->
        <section class="form-section">
          <h2 class="section-title">IDENTIFICACI√ìN</h2>
          <div class="field-row field-row-2">
            <div class="field">
              <label class="field-label">N¬∫ Factura*</label>
              <input
                type="text"
                class="field-input"
                [class.campo-fallido]="hasFieldError('numero_factura')"
                formControlName="numero_factura"
              />
            </div>
            <div class="field">
              <label class="field-label">Fecha*</label>
              <input
                type="date"
                class="field-input"
                [class.campo-fallido]="hasFieldError('fecha')"
                formControlName="fecha"
              />
            </div>
          </div>
        </section>

        <!-- IMPORTES E IVA -->
        <section class="form-section">
          <h2 class="section-title">IMPORTES E IVA</h2>

          <!-- L√≠nea Impositiva 1 -->
          <div class="subsection">
            <span class="subsection-label">L√çNEA IMPOSITIVA 1</span>
            <div class="field-row field-row-4">
              <div class="field">
                <label class="field-label">Base</label>
                <input
                  type="number"
                  step="0.01"
                  class="field-input"
                  [class.campo-fallido]="hasFieldError('base1')"
                  formControlName="base1"
                />
              </div>
              <div class="field">
                <label class="field-label">IVA %</label>
                <input
                  type="number"
                  step="0.01"
                  class="field-input"
                  [class.campo-fallido]="hasFieldError('iva1')"
                  formControlName="iva1"
                />
              </div>
              <div class="field">
                <label class="field-label">Cuota</label>
                <input
                  type="number"
                  step="0.01"
                  class="field-input"
                  [class.campo-fallido]="hasFieldError('cuota1')"
                  formControlName="cuota1"
                />
              </div>
              <div class="field">
                <label class="field-label">Rec.</label>
                <input
                  type="number"
                  step="0.01"
                  class="field-input"
                  [class.campo-fallido]="hasFieldError('recargo1')"
                  formControlName="recargo1"
                />
              </div>
            </div>
          </div>

          <!-- L√≠nea Impositiva 2 -->
          <div class="subsection">
            <span class="subsection-label">L√çNEA IMPOSITIVA 2</span>
            <div class="field-row field-row-4">
              <div class="field">
                <label class="field-label">Base</label>
                <input
                  type="number"
                  step="0.01"
                  class="field-input"
                  [class.campo-fallido]="hasFieldError('base2')"
                  formControlName="base2"
                />
              </div>
              <div class="field">
                <label class="field-label">IVA %</label>
                <input
                  type="number"
                  step="0.01"
                  class="field-input"
                  [class.campo-fallido]="hasFieldError('iva2')"
                  formControlName="iva2"
                />
              </div>
              <div class="field">
                <label class="field-label">Cuota</label>
                <input
                  type="number"
                  step="0.01"
                  class="field-input"
                  [class.campo-fallido]="hasFieldError('cuota2')"
                  formControlName="cuota2"
                />
              </div>
              <div class="field">
                <label class="field-label">Rec.</label>
                <input
                  type="number"
                  step="0.01"
                  class="field-input"
                  [class.campo-fallido]="hasFieldError('recargo2')"
                  formControlName="recargo2"
                />
              </div>
            </div>
          </div>

          <!-- L√≠nea Impositiva 3 -->
          <div class="subsection">
            <span class="subsection-label">L√çNEA IMPOSITIVA 3</span>
            <div class="field-row field-row-4">
              <div class="field">
                <label class="field-label">Base</label>
                <input
                  type="number"
                  step="0.01"
                  class="field-input"
                  [class.campo-fallido]="hasFieldError('base3')"
                  formControlName="base3"
                />
              </div>
              <div class="field">
                <label class="field-label">IVA %</label>
                <input
                  type="number"
                  step="0.01"
                  class="field-input"
                  [class.campo-fallido]="hasFieldError('iva3')"
                  formControlName="iva3"
                />
              </div>
              <div class="field">
                <label class="field-label">Cuota</label>
                <input
                  type="number"
                  step="0.01"
                  class="field-input"
                  [class.campo-fallido]="hasFieldError('cuota3')"
                  formControlName="cuota3"
                />
              </div>
              <div class="field">
                <label class="field-label">Rec.</label>
                <input
                  type="number"
                  step="0.01"
                  class="field-input"
                  [class.campo-fallido]="hasFieldError('recargo3')"
                  formControlName="recargo3"
                />
              </div>
            </div>
          </div>
        </section>

        <!-- RETENCIONES E IRPF -->
        <section class="form-section">
          <h2 class="section-title">RETENCIONES E IRPF</h2>
          <div class="field-row field-row-3">
            <div class="field">
              <label class="field-label">Base Ret.</label>
              <input
                type="number"
                step="0.01"
                class="field-input"
                [class.campo-fallido]="hasFieldError('base_retencion')"
                formControlName="base_retencion"
              />
            </div>
            <div class="field">
              <label class="field-label">% IRPF</label>
              <input
                type="number"
                step="1"
                class="field-input"
                [class.campo-fallido]="hasFieldError('porcentaje_retencion')"
                formControlName="porcentaje_retencion"
              />
            </div>
            <div class="field">
              <label class="field-label">Cuota Ret.</label>
              <input
                type="number"
                step="1"
                class="field-input"
                [class.campo-fallido]="hasFieldError('cuota_retencion')"
                formControlName="cuota_retencion"
              />
            </div>
          </div>
        </section>

        <!-- IMPORTE TOTAL -->
        <section
          class="form-section total-section"
          [class.total-section-error]="hasFieldError('importe_total')"
        >
          <div class="total-row">
            <span class="total-label">IMPORTE TOTAL</span>
            <span class="total-value">
              <input
                type="number"
                step="0.01"
                class="field-input total-input"
                [class.total-input-error]="hasFieldError('importe_total')"
                formControlName="importe_total"
              />
              <span
                class="currency"
                [class.currency-error]="hasFieldError('importe_total')"
                >‚Ç¨</span
              >
            </span>
          </div>
        </section>

        <!-- ENTIDADES -->
        <section class="form-section">
          <h2 class="section-title">ENTIDADES</h2>

          <!-- Proveedor -->
          <div class="entity-row">
            <div class="entity-field">
              <label class="field-label entity-label">Proveedor</label>
              <input
                type="text"
                class="field-input"
                [class.campo-fallido]="hasFieldError('nombre_proveedor')"
                formControlName="nombre_proveedor"
              />
            </div>
            <div class="entity-field">
              <label class="field-label">NIF Emisor</label>
              <input
                type="text"
                class="field-input"
                [class.campo-fallido]="hasFieldError('nif_emision')"
                formControlName="nif_emision"
              />
            </div>
          </div>

          <!-- Cliente -->
          <div class="entity-row">
            <div class="entity-field">
              <label class="field-label entity-label">Cliente</label>
              <input
                type="text"
                class="field-input"
                [class.campo-fallido]="hasFieldError('nombre_cliente')"
                formControlName="nombre_cliente"
              />
            </div>
            <div class="entity-field">
              <label class="field-label">NIF Receptor</label>
              <input
                type="text"
                class="field-input"
                [class.campo-fallido]="hasFieldError('nif_receptor')"
                formControlName="nif_receptor"
              />
            </div>
          </div>
        </section>
      </form>
    </div>
  </div>
</div>
